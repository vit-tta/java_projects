# Market
## Микросервисная система обработки заказов и платежей

---

## 1. Общая информация

В рамках данной работы была реализована микросервисная система для обработки заказов и платежей с использованием событийного взаимодействия.  
Система построена на основе Spring Boot и Apache Kafka и демонстрирует применение паттернов обеспечения согласованности данных в распределённых системах.

---

## 2. Архитектура системы

Система состоит из трёх микросервисов:

1. **API Gateway**
2. **Order Service**
3. **Payment Service**

Взаимодействие между сервисами осуществляется асинхронно через брокер сообщений Kafka.

### 2.1 API Gateway

API Gateway является единой точкой входа в систему и отвечает исключительно за маршрутизацию HTTP-запросов к соответствующим микросервисам.  
Бизнес-логика в gateway отсутствует, что соответствует принципам микросервисной архитектуры.

Gateway маршрутизирует:
- запросы `/api/orders/**` → Order Service
- запросы `/api/accounts/**` → Payment Service

---

### 2.2 Order Service

Order Service отвечает за:
- создание заказов;
- просмотр списка заказов пользователя;
- просмотр статуса конкретного заказа.

При создании заказа сервис:
1. сохраняет заказ в базе данных;
2. формирует событие `OrderCreatedEvent`;
3. сохраняет событие в таблицу outbox в рамках одной транзакции;
4. асинхронно публикует событие в Kafka через Outbox Processor.

Для обеспечения надёжной доставки используется паттерн **Transactional Outbox**.

---

### 2.3 Payment Service

Payment Service отвечает за:
- создание счёта пользователя;
- пополнение баланса;
- просмотр баланса;
- обработку платежей по заказам.

При получении события `OrderCreatedEvent` сервис:
1. сохраняет входящее событие в таблицу Inbox;
2. проверяет идемпотентность операции по `orderId`;
3. выполняет списание средств при наличии достаточного баланса;
4. сохраняет информацию о транзакции;
5. формирует событие `PaymentResultEvent`;
6. сохраняет событие в outbox и публикует его в Kafka.

В сервисе применены паттерны **Transactional Inbox** и **Transactional Outbox**.

---

## 3. Взаимодействие через Kafka

Для асинхронного взаимодействия используется Apache Kafka с семантикой доставки **at-least-once**.

Exactly-once семантика достигается на уровне бизнес-логики за счёт:
- идемпотентной обработки событий;
- проверки существования транзакции по `orderId`;
- отказа от повторного списания средств при получении дубликатов сообщений.

Таким образом, система корректно обрабатывает повторную доставку сообщений.

---

## 4. Обеспечение exactly-once семантики

Exactly-once семантика при списании средств достигается следующим образом:
- Kafka может доставлять сообщения повторно (at-least-once);
- Payment Service проверяет, был ли платёж по данному `orderId` уже обработан;
- при повторном получении события бизнес-операция не выполняется повторно.

Это гарантирует, что баланс пользователя и статус заказа не будут изменены более одного раза.

---

## 5. Пользовательский сценарий

Полный пользовательский сценарий выглядит следующим образом:

1. Пользователь создаёт счёт и пополняет баланс (Payment Service).
2. Пользователь создаёт заказ (Order Service).
3. Order Service публикует событие `OrderCreatedEvent`.
4. Payment Service обрабатывает платёж и публикует `PaymentResultEvent`.
5. Order Service обновляет статус заказа на основе результата платежа.

---

## 6. Тестирование API

Для демонстрации работы системы используется коллекция Postman, включающая:
- создание и пополнение счёта;
- просмотр баланса;
- создание заказа;
- просмотр заказов;
- проверку статуса заказа.

---

## 7. Контейнеризация и запуск

Все микросервисы упакованы в Docker-контейнеры.  
Система разворачивается с помощью `docker-compose.yml`, который включает:
- Kafka;
- Zookeeper;
- API Gateway;
- Order Service;
- Payment Service.
---

## 8. Инструкция по запуску

```docker-compose up -d zookeeper kafka```

```docker-compose up --build ```

